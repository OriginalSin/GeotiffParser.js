<!DOCTYPE html>
<!-- This Source Code Form is subject to the terms of the Mozilla Public
   - License, v. 2.0. If a copy of the MPL was not distributed with this
   - file, You can obtain one at http://mozilla.org/MPL/2.0/. -->
<html lang="en-US">
<head>
	<meta charset="UTF-8" />
	<title>TIFF test</title>
	<!--<script src="js/pako_deflate.min.js"></script>
	<script src="js/GeotiffParser.js"></script>-->
	<script data-main="js/GeotiffParser" src="js/require.js"></script>
	<script type="text/javascript">
		"use strict";
		var prepareTIFF = function() {
			var files = document.getElementById( "tiff-file" ).files;
			var file = files[0];

			if (files.length < 1 || file.type !== 'image/tiff') {
				return;
			}

			var reader = new FileReader();

			reader.onload = function(e) {

			
			var parser = new GeotiffParser();
		
	// loadPixels to read TIff / Geotiff parameter and get the buffer of pixels
	var pixels = parser.loadPixels(e.target.result);
		
	// Show Image parameter
	var width  = parser.imageWidth
	var height = parser.imageLength;
	console.log(" w=" + width + " h=" + height );
  
	// DataType  UChar8 or Int16
	var bitsPerPixel = parser.bitsPerPixel;
	console.log("bitsPerPixel=" +  bitsPerPixel);

	// Band count : 1 or 3 bands RGB
	var samplesPerPixel  = parser.samplesPerPixel;
	console.log("samplesPerPixel=" +  samplesPerPixel);
	console.log("PlanarConfiruration=" +parser.getPlanarConfiguration());
	// Get a sample of pixels value 
	for (var i =200; i <210 ; i++) {
		var j=200;
		console.log("x=" + i + " y=" + j + " pixels="+ parser.getPixelValue(pixels,i,j) );
	}
	
	// If a GeoTiff retrieve the BBOX 
	console.log("isGeotiff=" +  parser.isGeotiff());
	if (parser.isGeotiff())
	{
		console.log("CRS Code:" + parser.getCRSCode());
		
		var ul=  parser.ImageToPCS(0,0);
		var ur=  parser.ImageToPCS(width,0);
		var ll=  parser.ImageToPCS(0,height);
		var lr=  parser.ImageToPCS(width,height);
		if (ul[0]==1) console.log("UL=" +  ul[1],ul[2]); else console.log("UL= failure" ); 
		if (ur[0]==1) console.log("UR=" +  ur[1],ur[2]); else console.log("UR= failure" ); 
		if (ll[0]==1) console.log("LL=" +  ll[1],ll[2]); else console.log("LL= failure" ); 
		if (lr[0]==1) console.log("LR=" +  lr[1],lr[2]); else console.log("LR= failure" ); 
	
	}
			
			};

			reader.readAsArrayBuffer( file );
		}
	</script>
</head>
<body onload="prepareTIFF();">

<form name="tiff-parser" method="post" enctype="multipart/form-data" style="margin: 10% auto auto; text-align: center;">

	<input type="file" name="tiff-file" id="tiff-file" accept="image/tiff" required onchange="prepareTIFF();" />
	<input type="button" name="parse" value="Parse TIFF" onclick="prepareTIFF();" />

</form>

<canvas id="tiff-image" style="display: block; max-width: 95%; margin: 2em auto; border: 1px dashed magenta; padding: 0px; background-color: #FFEEFF;"></canvas>

</body>
</html>